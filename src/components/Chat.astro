---
// Chat: AI assistant interface
// Inline chat section - connects to self-hosted Talking Rock backend

// API URL: use environment variable with fallback for dev
const apiUrl = import.meta.env.PUBLIC_CHAT_API_URL || 'http://localhost:8000';
---

<section class="py-24 container-wide px-8 sm:px-12 lg:px-16">
  <div class="mb-12 reveal">
    <h2 class="text-3xl font-semibold mb-4">Chat with <span class="text-accent">Talking Rock</span></h2>
    <p class="text-text-secondary max-w-2xl">
      Kellogg's AI assistant, running on his home server. Ask about his work, skills, or approach to data problems.
    </p>
  </div>

  <div
    id="chat-container"
    class="reveal max-w-3xl mx-auto bg-surface-raised border border-accent/20 rounded-2xl overflow-hidden shadow-[0_0_40px_rgba(6,182,212,0.08)]"
    data-api-url={apiUrl}
  >
    <!-- Messages area -->
    <div id="chat-messages" class="h-[512px] overflow-y-auto p-6 space-y-4">
      <div class="flex gap-3">
        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-accent to-accent-dim flex items-center justify-center flex-shrink-0 shadow-[0_0_12px_rgba(6,182,212,0.3)]">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
        </div>
        <div class="text-sm text-text-secondary bg-accent/5 border border-accent/10 rounded-lg p-3 max-w-[80%]">
          <p>Hi! I'm Talking Rock, Kellogg's AI assistant running on his home server. Ask me about his work, skills, or approach to data problems.</p>
        </div>
      </div>
    </div>

    <!-- Input area -->
    <div class="p-4 border-t border-accent/10 bg-surface-overlay">
      <div class="flex gap-3">
        <input
          type="text"
          id="chat-input"
          placeholder="Type a message..."
          class="flex-grow px-4 py-3 bg-surface border border-border rounded-xl text-sm text-text-primary placeholder-text-muted focus:outline-none focus:border-accent focus:shadow-[0_0_12px_rgba(6,182,212,0.15)] transition-all disabled:opacity-50"
        />
        <button
          id="chat-send"
          class="px-5 py-3 bg-gradient-to-r from-accent-dim to-accent hover:from-accent hover:to-accent-hover rounded-xl transition-all flex items-center gap-2 shadow-[0_0_20px_rgba(6,182,212,0.2)] hover:shadow-[0_0_25px_rgba(6,182,212,0.35)] disabled:opacity-50 disabled:cursor-not-allowed"
          aria-label="Send message"
        >
          <span class="text-sm font-medium text-white hidden sm:inline">Send</span>
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
          </svg>
        </button>
      </div>
    </div>
  </div>
</section>

<script>
  const container = document.getElementById('chat-container');
  const input = document.getElementById('chat-input') as HTMLInputElement;
  const send = document.getElementById('chat-send') as HTMLButtonElement;
  const messages = document.getElementById('chat-messages');

  // Get API URL from data attribute (set by Astro at build time)
  const API_URL = container?.dataset.apiUrl || 'http://localhost:8000';

  // Track conversation for multi-turn
  let conversationId: string | null = null;

  // Avatar HTML templates
  const botAvatarHtml = `<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>`;
  const userAvatarHtml = `<svg class="w-4 h-4 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>`;

  // Typing indicator HTML
  const typingIndicatorHtml = `
    <div class="flex gap-1.5">
      <span class="w-2 h-2 bg-accent/60 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
      <span class="w-2 h-2 bg-accent/60 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
      <span class="w-2 h-2 bg-accent/60 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
    </div>
  `;

  const addMessage = (text: string, isUser: boolean, isTyping = false): HTMLElement => {
    const wrapper = document.createElement('div');
    wrapper.className = 'flex gap-3' + (isUser ? ' flex-row-reverse' : '');
    if (isTyping) wrapper.id = 'typing-indicator';

    const avatar = document.createElement('div');
    avatar.className = isUser
      ? 'w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 bg-surface-overlay border border-border'
      : 'w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 bg-gradient-to-br from-accent to-accent-dim shadow-[0_0_12px_rgba(6,182,212,0.3)]';
    avatar.innerHTML = isUser ? userAvatarHtml : botAvatarHtml;

    const bubble = document.createElement('div');
    bubble.className = isUser
      ? 'text-sm rounded-lg p-3 max-w-[80%] bg-surface-overlay border border-border text-text-primary'
      : 'text-sm rounded-lg p-3 max-w-[80%] bg-accent/5 border border-accent/10 text-text-secondary';

    if (isTyping) {
      bubble.innerHTML = typingIndicatorHtml;
    } else {
      bubble.textContent = text;
    }

    wrapper.appendChild(avatar);
    wrapper.appendChild(bubble);
    messages?.appendChild(wrapper);
    messages?.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });

    return wrapper;
  };

  const removeTypingIndicator = () => {
    const indicator = document.getElementById('typing-indicator');
    indicator?.remove();
  };

  const setInputEnabled = (enabled: boolean) => {
    input.disabled = !enabled;
    send.disabled = !enabled;
  };

  const sendMessage = async () => {
    const text = input?.value.trim();
    if (!text) return;

    // Add user message and clear input
    addMessage(text, true);
    input.value = '';

    // Disable input while waiting
    setInputEnabled(false);

    // Show typing indicator
    addMessage('', false, true);

    try {
      const response = await fetch(`${API_URL}/chat`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          message: text,
          conversation_id: conversationId,
        }),
      });

      // Remove typing indicator
      removeTypingIndicator();

      if (!response.ok) {
        // Handle HTTP errors
        if (response.status === 429) {
          addMessage("I'm getting a lot of requests right now. Please wait a moment and try again.", false);
        } else if (response.status >= 500) {
          addMessage("I'm having trouble connecting to my backend. Please try again in a moment.", false);
        } else {
          addMessage("Something went wrong. Please try again.", false);
        }
        return;
      }

      const data = await response.json();

      // Update conversation ID for multi-turn
      if (data.metadata?.conversation_id) {
        conversationId = data.metadata.conversation_id;
      }

      if (data.success && data.response?.content) {
        addMessage(data.response.content, false);
      } else if (data.error?.message) {
        addMessage(data.error.message, false);
      } else {
        addMessage("I couldn't process that request. Please try again.", false);
      }
    } catch (error) {
      // Remove typing indicator on error
      removeTypingIndicator();

      // Network or other errors
      console.error('Chat error:', error);
      addMessage("I couldn't reach my backend server. Please check your connection and try again.", false);
    } finally {
      // Re-enable input
      setInputEnabled(true);
      input?.focus();
    }
  };

  send?.addEventListener('click', sendMessage);
  input?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !input.disabled) sendMessage();
  });
</script>
